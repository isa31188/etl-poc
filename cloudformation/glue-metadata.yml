
AWSTemplateFormatVersion: "2010-09-09"
Description: Glue resources for metadata

Resources:

  ETLPOCDatabase:
    Type: "AWS::Glue::Database"
    Properties:
      DatabaseInput:
        Description: "Database for tables of the ETL POC"
        Name: etl_poc_database
      CatalogId: !Ref AWS::AccountId

  RawDataTable:
    Type: "AWS::Glue::Table"
    DependsOn: ETLPOCDatabase
    Properties:
      TableInput:
        Description: "Original table as extracted from the source."
        TableType: "EXTERNAL_TABLE"
        Parameters: {
                "CrawlerSchemaDeserializerVersion": "1.0",
                "compressionType": "none",
                "classification": "csv",
                "recordCount": "2000000",
                "typeOfData": "file",
                "CrawlerSchemaSerializerVersion": "1.0",
                "columnsOrdered": "true",
                "objectCount": "1",
                "delimiter": ",",
                "skip.header.line.count": "1"
        }
        StorageDescriptor:
          StoredAsSubDirectories: False
          Parameters: {
                  "CrawlerSchemaDeserializerVersion": "1.0",
                  "compressionType": "none",
                  "classification": "csv",
                  "recordCount": "2000000",
                  "typeOfData": "file",
                  "CrawlerSchemaSerializerVersion": "1.0",
                  "columnsOrdered": "true",
                  "objectCount": "1",
                  "delimiter": ",",
                  "skip.header.line.count": "1"
          }
          InputFormat: "org.apache.hadoop.mapred.TextInputFormat"
          OutputFormat: "org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat"
          Columns:
            - Type: string
              Name: Region
            - Type: string
              Name: Country
            - Type: string
              Name: Item Type
            - Type: string
              Name: Sales Channel
            - Type: string
              Name: Order Priority
            - Type: string
              Name: Order Date
            - Type: bigint
              Name: Order ID
            - Type: string
              Name: Ship Date
            - Type: bigint
              Name: Units Sold
            - Type: float
              Name: Unit Price
            - Type: float
              Name: Unit Cost
            - Type: float
              Name: Total Revenue
            - Type: float
              Name: Total Cost
            - Type: float
              Name: Total Profit
          SerdeInfo:
            Parameters: {
                        "field.delim": ","
            }
            SerializationLibrary: "org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe"
          Compressed: False
          Location: !Sub "s3://etl-poc-data-raw/2m-Sales-Records.csv"
        Retention: 0
        Name: raw_data_table
      DatabaseName: !Ref ETLPOCDatabase
      CatalogId: !Ref AWS::AccountId

  CrawlerRawData:
    Type: AWS::Glue::Crawler
    Properties:
      Name: "crawler_raw_data"
      Role: !Ref CrawlerRole
      DatabaseName: !Ref ETLPOCDatabase
      RecrawlPolicy: 
        RecrawlBehavior: CRAWL_EVERYTHING        
      Targets:
        S3Targets:
          - Path: s3://etl-poc-data-raw
          - Exclusions: "**.zip"
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: LOG 
      Configuration: "{\"Version\":1.0,\"Grouping\":{\"TableGroupingPolicy\":\"CombineCompatibleSchemas\"}}"    
      Tags: {
        DataCrawler: CrawlerRawData
      }


  CrawlerRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - glue.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/"

  S3Policy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyDocument: {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": "glue:*",
            "Resource": "*"
          },
          {
            "Effect": "Allow",
            "Action": "s3:*",
            "Resource": "*"
          },
          {
            "Effect": "Allow",
            "Action": [
              "logs:CreateLogStream",
              "logs:PutLogEvents"
            ],
            "Resource": "*"
          },
          {
            "Effect": "Allow",
            "Action": "logs:CreateLogGroup",
            "Resource": "*"
          }
        ]
      }
      PolicyName: "GlueCrawlerPolicy"
      Roles:
        - !Ref CrawlerRole